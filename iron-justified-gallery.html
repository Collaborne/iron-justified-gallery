<link rel="import" href="../polymer/polymer.html">

<script type="text/javascript" src="../justified-layout/index.js"></script>

<!--
A gallery for images using flickr justified-layout.

### Example

```html
<iron-justified-gallery images="[[array]]" gallery-width="500" row-height="220">
</iron-justified-gallery>
```

@demo demo/index.html
-->
<dom-module id="iron-justified-gallery">

	<template>

		<style>
			:host {
				position: relative;
				display: block;
			}
		</style>

	</template>
</dom-module>

<script>

(function() {
	const justifiedLayout = require('justified-layout');

	Polymer({
		is: 'iron-justified-gallery',
		properties: {
			/**
			 * Input of images for the galery
			 */
			images: {
				type: Array,
				observer: '_onImagesChanged',
				value: []
			},
			/**
			 * Width of the whole gallery
			 * This value defaults to width of the window.
			 */
			galleryWidth: Number,
			/**
			 * Height of a single row in the gallery
			 */
			rowHeight: {
				type: Number,
				value: 200
			}

		},

		listeners: {
			'tap': '_onTap'
		},

		// Private methods
		/**
		 * On images changed recalculates the gallery
		 *
		 * @param images array of objects with the image url and image widht
		 */
		_onImagesChanged: function(images) {
			const galleryParameters = {
				galleryWidth: this.galleryWidth ? this.galleryWidth : window.innerWidth,
				targetRowHeight: this.rowHeight
			};

			// generates the correct dimensions and attaches them to the DOM
			this._renderImages(
				galleryParameters,
				images
			);
		},
		/**
		 * Generates the elements that are going to hold the images with the right positioning and dimensions.
		 * Attaches the elements to the DOM.
		 *
		 * @param config is the desired configurations of the gallery
		 * @param images is the array of images that will be rendered
		 */
		_renderImages: function(config, images) {
			// extract image widths
			const arrayOfWidths = images.map(image => image.width);
			const normalizedVector = this._computeNormalizedArrayOfWidths(arrayOfWidths);
			const geometry = justifiedLayout(normalizedVector, config);
			let elementsToBeAttached = '';

			for (var i = 0; i < images.length; i++) {
				const url = images[i].url;
				const box = geometry.boxes[i];
				elementsToBeAttached += `<div index="${i}" ; style="background-size: cover; background-position: center center; background-image: url(${url}); width: ${box.width}px; height: ${box.height}px; top: ${box.top}px; left: ${box.left}px; position: absolute;"></div>`;
			}

			// attach the elements and set the dimensions of the gallery
			this.innerHTML = elementsToBeAttached;
			this.style.height = geometry.containerHeight + "px";
			this.style.width = config.galleryWidth + "px";
		},
		/**
		 * Handles the tap on an image.
		 *
		 * @fires 'tap-image' with an image that was tapped as a detail
		 */
		_onTap: function(e) {
			// find the index of the image that was tapped
			const indexOfTappedImage = e.target.outerHTML.match(/\d+/);
			this.fire('tap-image', this.images[indexOfTappedImage]);
		},
		/**
		 * Computes the normalized vector of all attached images. The
		 * vector is normalized by minimum value.
		 *
		 * @param arrayOfWidths an array of all images widths
		 */
		_computeNormalizedArrayOfWidths: function(arrayOfWidths) {
			const minimum = Math.min.apply(Math, arrayOfWidths);
			return arrayOfWidths.map(vetorCell => vetorCell / minimum);
		},
	});

})();

</script>
