<link rel="import" href="../polymer/polymer.html">

<script type="text/javascript" src="../justified-layout/index.js"></script>

<!--
A gallery for pictures using flickr justified-layout.

### Example

```html
<iron-justified-gallery pictures="[[array]]" gallery-width="500" row-height="220">
</iron-justified-gallery>
```

@demo demo/index.html
-->
<dom-module id="iron-justified-gallery">

	<template>

		<style>
			#frameHolder {
				position: relative;
			}
		</style>

		<div id="frameHolder"></div>

	</template>
</dom-module>

<script>

(function() {

	Polymer({
		is: 'iron-justified-gallery',
		properties: {
			/**
			 * Input of pictures for the galery
			 */
			pictures: {
				type: Array,
				observer: '_onPicturesChanged',
				value: []
			},
			/**
			 * Width of the whole gallery
			 */
			galleryWidth: Number,
			/**
			 * Height of a single row in the gallery
			 */
			rowHeight: {
				type: Number,
				value: 200
			}

		},

		// Private methods
		/**
		 * On pictures changed recalculates the gallery
		 *
		 * @param pictures array of objects with the picture url and picture widht
		 */
		_onPicturesChanged: function(pictures) {
			var galeryParameters = {
				containerWidth: this.galleryWidth ? this.galleryWidth : window.innerWidth,
				targetRowHeight: this.rowHeight,
				targetRowHeightTolerance: 0.25,
			};

			// extract picture widths
			const ratioVector = pictures.map(picture => {
					return picture.width;
			});

			// generates the correct dimensions and attaches them to the DOM
			this._generatePictureDimensions(
				this._computeNormalizedRatioVector(ratioVector),
				'frameHolder',
				galeryParameters,
				pictures
			);
		},
		/**
		 * Generates the boxes that are going to hold the pictures
		 *
		 * @param input are the aspect ratios (http://code.flickr.net/2016/04/05/our-justified-layout-goes-open-source/)
		 * @param container is the place where the frames will be attached, for example id parameter of a div
		 * @param config is the desired configurations of the gallery
		 * @param images is the array of pictures that will be rendered
		 */
		_generatePictureDimensions: function(input, container, config, images) {
			const justifiedLayout = require('justified-layout');
			const geometry = justifiedLayout(input, config);

			const frames = geometry.boxes.map(box => {
				const url = images[geometry.boxes.indexOf(box)].url;
				return  `<div class="box" style="background-size: cover!important; background: url(${url}); width: ${box.width}px; height: ${box.height}px; top: ${box.top}px; left: ${box.left}px; position: absolute;"></div>`;
			}).join('');

			this.$[container].innerHTML = frames;
			this.$[container].style.height = geometry.containerHeight + "px";
			this.$[container].style.width = config.containerWidth + "px";
		},
		/**
		 * Using the image sizes computes the normalized vector of all images attached. the
		 * vector is normalized by minimum value
		 *
		 * @param ratioVector an array of all pictures widths
		 */
		_computeNormalizedRatioVector: function(ratioVector) {
			const minimum = Math.min.apply(Math, ratioVector);

			return normalizedRatioVector = ratioVector.map(vetorCell => {
				return vetorCell / minimum;
			});
		},
	});

})();

</script>
